#!/bin/bash

#è‹±èªãƒ»æ—¥æœ¬èªåˆ‡ã‚Šæ›¿ãˆ
source "/usr/bin/gettext.sh"

TEXTDOMAIN="ex_function_new"
export TEXTDOMAIN

TEXTDOMAINDIR="$(pwd)/locale"
export TEXTDOMAINDIR

#çµ‚äº†ãƒãƒ³ãƒ‰ãƒ©
trap 'ex_fin' 1 2 3 15

# ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚„ãƒ‡ãƒ¼ã‚¿ã®é…ç½®å ´æ‰€
DEST=/opt/snk

#éå»ãƒ‡ãƒ¼ã‚¿æ¶ˆå»
ex_erase () {
        echo
        echo "******************************************************************"
        echo "$(eval_gettext 'ExperimentPreparation')"

        #optimizerã®åœæ­¢
        if [ "$(supervisorctl status all|grep ^optimizer)" != "" ]; then
            supervisorctl stop optimizer
            supervisorctl remove optimizer
            echo "$(eval_gettext 'Optimizer has been stopped')"
            #echo "optimizerã‚’åœæ­¢ã—ã¾ã—ãŸ"
        fi
        #

        #ãƒ‡ãƒ¼ã‚¿æ¶ˆå»(æŒ‡å®šãŒã‚ã‚Œã°)
        if [ "$*" != "" ]; then
            #ãƒ‡ãƒ¼ãƒ¢ãƒ³åœæ­¢
            supervisorctl stop cyclic controller

            for i in $*; do
                if [ "$i" == "output" ]; then
                    #ãƒ‡ãƒ¼ã‚¿ã®æ¶ˆå»
                    rm -f $DEST/output/*.log
                    rm -f $DEST/output/*.json
                    printf "$(eval_gettext 'Log/json in %s/output has been erased')\n"
                    "$DEST"
                    #echo "$DEST/outputã®ä¸­ã®logãƒ»jsonã‚’æ¶ˆå»ã—ã¾ã—ãŸ"
                elif [ "$i" == "data" ]; then
                    rm -f $DEST/data/pid.json
                    echo "$(eval_gettext 'Deleted pid.json in data')"
                    #echo "dataã®ä¸­ã®pid.jsonã‚’æ¶ˆå»ã—ã¾ã—ãŸ"
                fi
            done

            #ãƒ‡ãƒ¼ãƒ¢ãƒ³å†èµ·å‹•
            supervisorctl start cyclic controller
            echo "$(eval_gettext 'waiting for daemon')"
            #echo "ãƒ‡ãƒ¼ãƒ¢ãƒ³èµ·å‹•å¾…ã¡"
            while [ "$(supervisorctl status cyclic|grep RUNNING)" == "" ]; do
                sleep 1s
            done
            echo "$(eval_gettext 'cyclic has been activated.')"
            #echo "cyclicãŒèµ·å‹•ã—ã¾ã—ãŸ"
            while [ "$(supervisorctl status controller|grep RUNNING)" == "" ]; do
                sleep 1s
            done
            echo "$(eval_gettext 'controller has been activated.')"
            #echo "controllerãŒèµ·å‹•ã—ã¾ã—ãŸ"
        fi
}

#æš–æ©Ÿé‹è»¢é–‹å§‹
ex_warm () {
        echo
        echo "******************************************************************"
        echo "$(eval_gettext 'Start warm-up operation')"
        #echo "æš–æ°—é‹è»¢ã‚’é–‹å§‹"

        #PID1,PID2ã‚’MNãƒ¢ãƒ¼ãƒ‰ã«å¤‰æ›´
        mosquitto_pub -h localhost -t snk/1 -m '{"PID1-AT/MT-remote": 1}'
        mosquitto_pub -h localhost -t snk/1 -m '{"PID2-AT/MT-remote": 1}'
        mosquitto_pub -h localhost -t snk/1 -m '{"PID1-value-remote": 1.0}'
        mosquitto_pub -h localhost -t snk/1 -m '{"PID2-value-remote": 0.0}'
        echo "$(eval_gettext 'Heater outlet control set to 100%, inlet control set to 0')"
        #echo "ãƒ’ãƒ¼ã‚¿ãƒ¼å‡ºå£åˆ¶å¾¡100%ã€å…¥å£åˆ¶å¾¡0%ã«è¨­å®šã—ã¾ã—ãŸ"

        #é›»æºã€ãƒ’ãƒ¼ã‚¿ãƒ¼ON
        mosquitto_pub -h localhost -t snk/1 -m '{"on/off-remote": 1}'
        mosquitto_pub -h localhost -t snk/1 -m '{"Heater-value-remote": 100}'
        echo "$(eval_gettext 'Power and heaters turned on.')"
        #echo "é›»æºã€ãƒ’ãƒ¼ã‚¿ãƒ¼ã‚’onã«ã—ã¾ã—ãŸ"
}

#æŒ‡å®šã—ãŸæ™‚é–“ã ã‘å¾…ã¤
ex_wait () {
    echo
    echo "$(eval_gettext 'waiting time')"

    printf "$(eval_gettext '%s I will wait.')\n"
    "$1"
    sleep "$1"
}

#ä»»æ„ã®ãƒ¬ã‚¸ã‚¹ã‚¿ã®è¨­å®šå€¤å¤‰æ›´
ex_set_value () {
        register=$1
        value=$2
        echo
        echo "******************************************************************"
        echo "$(eval_gettext 'Setting value change')"

        printf "$(eval_gettext 'Sets the value of %s to %s')"
        "$register" "value"

        mosquitto_pub -h localhost -t snk/1 -m "{\"$register\": $value}"
        v=`mosquitto_sub -h localhost -t snk/0 -C 1|sed -e 's/,/\n/g'|grep "\"$register\":"|awk '{print $2}'`
        printf "$(eval_gettext 'The value of %s is now %s')"
        "$register" "$v"

        if [ "$value" != "$v" ]; then
            printf "$(eval_gettext 'Error: %s and %s are different')\n"
            "$value" "$v"
        fi
}

#PIDè¨­å®šæ¸©åº¦(ç›®æ¨™æ¸©åº¦SV)ã®è¨­å®š
ex_pidSV () {
        echo
        echo "******************************************************************"
        echo "$(eval_gettext 'PID set temperature (target temperature SV)')"

        printf "$(eval_gettext 'Set to r:%f')\n"
	"$1"

        mosquitto_pub -h localhost -t snk/1 -m "{\"r\": $1}"
        r=`mosquitto_sub -h localhost -t snk/0 -C 1|sed -e 's/,/\n/g'|grep '"r"'|awk '{print $2}'`

        printf "$(eval_gettext 'r:%f now.')\n"
        "$r"
}

#PIDè¨­å®šæ¸©åº¦(ç›®æ¨™æ¸©åº¦SV)ã®è¨­å®š(2ç³»çµ±ã‚ã‚‹å ´åˆ)
ex_pidSV2 () {
        echo
        echo "******************************************************************"
        echo "$(eval_gettext 'PID set temperature (target temperature SV)')"

        printf "$(eval_gettext 'Set to r:%s r1:%s')\n"
        "$1" "$2"

        mosquitto_pub -h localhost -t snk/1 -m "{\"r\": $1}"
        mosquitto_pub -h localhost -t snk/1 -m "{\"r1\": $2}"
        r=`mosquitto_sub -h localhosşt -t snk/0 -C 1|sed -e 's/,/\n/g'|grep '"r"'|awk '{print $2}'`
        r1=`mosquitto_sub -h localhost -t snk/0 -C 1|sed -e 's/,/\n/g'|grep '"r1"'|awk '{print $2}'`

        printf "$(eval_gettext 'r:%s r1:%s now.')\n"
        "$r" "$r1"
}

#PIDåˆ¶å¾¡å€¤ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«é¸åˆ¥
ex_pidrandam () {
        echo
        echo "******************************************************************"
        echo "$(eval_gettext 'Changes the PID control setpoint.')"

        #Kpã®åˆ¶å¾¡è¨­å®š
        randKp=`shuf -i 1-50000 -n1`
        fewKp1=`shuf -i 1-99 -n1`
        randKp1=$(python -c "print($randKp*0.000001)")
        #Tdã®åˆ¶å¾¡è¨­å®š
        randTd=`shuf -i 1-300 -n1`
        fewTd1=`shuf -i 1-99 -n1`
        fewTd2=$(python -c "print($fewTd1*0.01)")
        randTd1=$(python -c "print($randTd+$fewTd2)")
        #Tiã®åˆ¶å¾¡è¨­å®šå€¤
        randTi=`shuf -i 0-300 -n1`
        fewTi1=`shuf -i 1-99 -n1`
        fewTi2=$(python -c "print($fewTi1*0.01)")
        randTi1=$(python -c "print($randTi+$fewTi2)")
        mosquitto_pub -h localhost -t snk/1 -m "{\"Kp\": $randKp1}"
        mosquitto_pub -h localhost -t snk/1 -m "{\"Td\": $randTd1}"
        mosquitto_pub -h localhost -t snk/1 -m "{\"Ti\": $randTi1}"
        #### è¨­å®šã•ã‚ŒãŸã‹subã§èª­ã¿è¾¼ã‚“ã§ç¢ºèªã—ãŸçµæœã‚’è¡¨ç¤ºã—ãŸã„ ####
        Kpsub=`mosquitto_sub -h localhost -t snk/0 -C 1|sed -e 's/,/\n/g'|grep '"Kp"'|awk '{print $2}'`
        Tdsub=`mosquitto_sub -h localhost -t snk/0 -C 1|sed -e 's/,/\n/g'|grep '"Td"'|awk '{print $2}'`
        Tisub=`mosquitto_sub -h localhost -t snk/0 -C 1|sed -e 's/,/\n/g'|grep '"Ti"'|awk '{print $2}'`
        echo "$(eval_gettext 'Set by random numbers')"
        echo "Kp:$randKp1, Td:$randTd1, Ti:$randTi1"

        echo "$(eval_gettext 'Loading with sub')"
        echo "Kp:$Kpsub, Td:$Tdsub, Ti:$Tisub"
}

#PIDåˆ¶å¾¡è¨­å®šå€¤ã®å¤‰æ›´
ex_pid () {
        echo
        echo "******************************************************************"
        echo "$(eval_gettext 'Changes the PID control setpoint.')"

        #Kpã®åˆ¶å¾¡è¨­å®šå€¤
        mosquitto_pub -h localhost -t snk/1 -m "{\"Kp\": $1}"
        #Tdã®åˆ¶å¾¡è¨­å®šå€¤
        mosquitto_pub -h localhost -t snk/1 -m "{\"Td\": $2}"
        #Tiã®åˆ¶å¾¡è¨­å®šå€¤
        mosquitto_pub -h localhost -t snk/1 -m "{\"Ti\": $3}"
        #### è¨­å®šã•ã‚ŒãŸã‹subã§èª­ã¿è¾¼ã‚“ã§ç¢ºèªã—ãŸçµæœã‚’è¡¨ç¤ºã—ãŸã„ ####
        Kpsub=`mosquitto_sub -h localhost -t snk/0 -C 1|sed -e 's/,/\n/g'|grep '"Kp"'|awk '{print $2}'`
        Tdsub=`mosquitto_sub -h localhost -t snk/0 -C 1|sed -e 's/,/\n/g'|grep '"Td"'|awk '{print $2}'`
        Tisub=`mosquitto_sub -h localhost -t snk/0 -C 1|sed -e 's/,/\n/g'|grep '"Ti"'|awk '{print $2}'`
        echo "$(eval_gettext 'Set to the following PID control parameters')"
        echo "Kp:$1, Td:$2, Ti:$3"

        echo "$(eval_gettext 'Loading with sub')"
        echo "Kp:$Kpsub, Td:$Tdsub, Ti:$Tisub"
}

#ãƒ’ãƒ¼ã‚¿ãƒ¼å‡ºå£æ¸©åº¦ã®ä¸Šæ˜‡
ex_tempup () {
        temp=$1
        echo
        echo "******************************************************************"
        printf "$(eval_gettext 'Raises the measured temperature (y) of PID1 to %s degree')\n"
        "$temp"

        y=`mosquitto_sub -h localhost -t snk/0 -C 1|sed -e 's/,/\n/g'|grep '"y"'|awk '{print $2}'`
        until [ `echo "$y >= $temp"|bc` == 1 ]
        do
                y=`mosquitto_sub -h localhost -t snk/0 -C 1|sed -e 's/,/\n/g'|grep '"y"'|awk '{print $2}'`
        done

        printf "$(eval_gettext 'Measured temperature (y) of PID1 has increased to %s degree')\n"
        "$temp"
}

#ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ã€å®Ÿé¨“é–‹å§‹æ™‚åˆ»è¨˜éŒ²
ex_time () {
        #å®Ÿé¨“é–‹å§‹æ™‚åˆ»
        echo
        echo "******************************************************************"
        echo "$(eval_gettext 'Start of experiment')"

        time2=`mosquitto_sub -h localhost -t snk/0 -C 1|sed -e 's/,/\n/g'|grep '"time"'|awk '{print $2}'`
        time3=${time2/%?/}
        time4=$(date -d @$time3)

        printf "$(eval_gettext 'Experiment start time:%s')\n"
	"$temp"

	#PIDåˆ¶å¾¡ã‚’AUTOãƒ¢ãƒ¼ãƒ‰ã«å¤‰æ›´
        mosquitto_pub -h localhost -t snk/1 -m '{"PID1-AT/MT-remote": 0}'
        mosquitto_pub -h localhost -t snk/1 -m '{"PID2-AT/MT-remote": 0}'
        echo "$(eval_gettext 'Switch to auto mode')"
}

#ãƒ©ãƒ³ãƒ€ãƒ è¨­å®š
ex_pid_schedule () {
        echo
        echo "******************************************************************"
        echo "$(eval_gettext 'pid control parameters electric heater output schedule random setting')"

        #pidãƒ©ãƒ³ãƒ€ãƒ è¨­å®š
        #ãƒ‘ã‚¿ãƒ¼ãƒ³æ•°æ±ºå®š
        pid_pattern=`shuf -i 1-10 -n1`
        for ((k=0 ; k<pid_pattern ; k++))
        do
                #pidãƒ©ãƒ³ãƒ€ãƒ è¨­å®šå‘¼ã³å‡ºã—
                ex_pidrandam
                #é›»æ°—ãƒ’ãƒ¼ã‚¿å‡ºåŠ›ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ©ãƒ³ãƒ€ãƒ è¨­å®š
                #ãƒ‘ã‚¿ãƒ¼ãƒ³æ•°æ±ºå®š
                schedule_pattern=`shuf -i 1-10 -n1`
                for ((j=0 ; j<schedule_pattern ; j++))
                do
                        #ãƒ’ãƒ¼ã‚¿å‡ºåŠ›
                        r_schedule=`shuf -i 0-100 -n1`
                        #å®Ÿé¨“æ™‚é–“
                        r_etime=`shuf -i 60-100 -n1`

                        printf "$(eval_gettext 'Load factor:%s parsent Experiment time:%s')\n"
                        "$r_schedule" "$r_etime"

                        mosquitto_pub -h localhost -t snk/1 -m "{\"Heater-value-remote\": $r_schedule}"
                        sleep "$r_etime"h
                done
        done
}

#ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«é‹è»¢è¨­å®š
ex_start () {
        printf "$(eval_gettext 'Load factor:%s % Experiment time:%s')\n"
        "$1" "$2"

        mosquitto_pub -h localhost -t snk/1 -m "{\"Heater-value-remote\": $1}"
        etime="$2"
        sleep "$etime"
}

#å®Ÿé¨“çµ‚äº†
ex_fin () {
        echo
        echo "******************************************************************"
        echo "$(eval_gettext 'End of experiment')"

        #è£…ç½®åœæ­¢
        mosquitto_pub -h localhost -t snk/1 -m '{"Heater-value-remote": 0}'
        mosquitto_pub -h localhost -t snk/1 -m '{"on/off-remote": 0}'
        echo "$(eval_gettext 'Equipment has been shut down.')"

        #æ™‚åˆ»è¨ˆç®—
        time2=`mosquitto_sub -h localhost -t snk/0 -C 1|sed -e 's/,/\n/g'|grep '"time"'|awk '{print $2}'`
        time3=${time2/%?/}
        time4=$(date -d @$time3)

        #ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜
        time=`date '+%Y%m%d_%H%M%S'`
        mkdir -p result_${time}
        cp -pr $DEST/data result_${time}/
        printf "$(eval_gettext 'Copied %s/data to result_%s/data.')\n"
        "$DEST" "$time"

        cp -pr $DEST/output result_${time}/
        printf "$(eval_gettext 'Copied %s/data to result_%s/output.')\n"
        "$DEST" "$time"

        printf "$(eval_gettext 'Experiment end time:%s')\n"
        "$time4"
}
